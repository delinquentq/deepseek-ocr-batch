{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/fin_report_extract.v1_3_1.json",
  "title": "Financial Report Extraction (v1.3.1, backward compatible with v1.3.0)",
  "type": "object",
  "required": ["schema_version", "doc", "passages", "entities", "data"],
  "properties": {
    "schema_version": { "type": "string", "const": "1.3.1" },

    "doc": {
      "type": "object",
      "required": ["doc_id", "title", "timestamps", "extraction_run"],
      "properties": {
        "doc_id": { "type": "string", "description": "文档稳定ID（如内容hash/URI+hash）" },
        "title": { "type": "string" },
        "source_uri": { "type": "string", "description": "文件名或URL" },
        "language": { "type": "string", "description": "en/zh/..." },
        "report_date": { "type": "string", "format": "date" },
        "report_type": { "type": "string", "enum": ["company","sector","macro","other"] },
        "sector": { "type": "string" },
        "tickers": { "type": "array", "items": { "type": "string" } },
        "symbols": { "type": "array", "items": { "type": "string" }, "description": "tickers 的别名（可选，兼容旧结构）" },
        "word_count": { "type": "integer", "minimum": 0 },
        "full_text": { "type": "string", "description": "可选：报告全文原文，便于审计/重切分" },

        "timestamps": {
          "type": "object",
          "required": ["ingested_at","extracted_at"],
          "properties": {
            "ingested_at": { "type": "string", "format": "date-time" },
            "extracted_at": { "type": "string", "format": "date-time" }
          }
        },

        "extraction_run": {
          "type": "object",
          "required": ["pipeline_steps"],
          "properties": {
            "vision_model": { "type": "string" },
            "synthesis_model": { "type": "string" },
            "validation_model": { "type": "string" },
            "pipeline_steps": { "type": "array", "items": { "type": "string" } },
            "runtime": { "type": "string" },
            "processing_metadata": {
              "type": "object",
              "properties": {
                "pages_processed": { "type": "integer", "minimum": 0 },
                "successful_pages": { "type": "integer", "minimum": 0 },
                "notes": { "type": "string" }
              },
              "description": "兼容/吸收另一份结构中的处理统计信息"
            }
          }
        }
      }
    },

    "passages": {
      "type": "array",
      "description": "用于RAG的可检索文本片段（段落/要点/标题/脚注等）",
      "items": {
        "type": "object",
        "required": ["passage_id","text","page"],
        "properties": {
          "passage_id": { "type": "string" },
          "page": { "type": "integer", "minimum": 1 },
          "bbox": { "$ref": "#/$defs/bbox" },
          "section": { "type": "string", "description": "章节/小节标题" },
          "text": { "type": "string" },
          "labels": { "type": "array", "items": { "type": "string" }, "description": "如 executive_summary, risk, guidance 等" },
          "entities": { "type": "array", "items": { "type": "string" }, "description": "引用 entities.entity_id" }
        }
      }
    },

    "entities": {
      "type": "array",
      "description": "标准化实体（公司/指数/政府/产品线等）",
      "items": {
        "type": "object",
        "required": ["entity_id","name"],
        "properties": {
          "entity_id": { "type": "string" },
          "type": { "type": "string", "enum": ["company","index","government","product","other"] },
          "name": { "type": "string" },
          "ticker": { "type": "string" },
          "isin": { "type": "string" },
          "lei": { "type": "string" },
          "country": { "type": "string" },
          "aliases": { "type": "array", "items": { "type": "string" } }
        }
      }
    },

    "data": {
      "type": "object",
      "required": ["figures","tables","numerical_data","claims","relations","extraction_summary"],
      "properties": {

        "figures": {
          "type": "array",
          "description": "图表及其可重建数据",
          "items": {
            "type": "object",
            "required": ["figure_id","title","page","type","series","provenance"],
            "properties": {
              "figure_id": { "type": "string", "description": "内容稳定ID（基于标题/labels/series的hash）" },
              "figure_key": { "type": "string", "description": "来源里的原始ID（可选）" },
              "title": { "type": "string" },
              "description": { "type": "string", "description": "补充说明（来自图注或上下文）" },
              "caption": { "type": "string" },
              "page": { "type": "integer", "minimum": 1 },

              "type": {
                "type": "string",
                "enum": ["bar","line","area","pie","scatter","heatmap","waterfall","combo","other"],
                "description": "兼容旧命名见 compat.type_aliases"
              },

              "chart_subtype": {
                "type": "string",
                "enum": ["plain","stacked","stacked_100","grouped","dual_axis","other"],
                "default": "plain"
              },

              "entities": { "type": "array", "items": { "type": "string" } },

              "axes": {
                "type": "object",
                "properties": {
                  "x": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "enum": ["time","category","number","fiscal_quarter","fiscal_year"] },
                      "calendar": { "type": "string", "enum": ["fiscal","calendar"], "description": "x 轴若为时间/期间，标注口径" },
                      "fiscal_year_end_month": { "type": "integer", "minimum": 1, "maximum": 12 },
                      "time_format": { "type": "string", "description": "如 YYYY, YYYY-MM, YYYYQn" },
                      "labels_raw": { "type": "array", "items": { "type": "string" } },
                      "labels_norm": { "type": "array", "items": { "type": "string" } },
                      "fiscal_periods": { "type": "array", "items": { "$ref": "#/$defs/fiscal_period" } }
                    }
                  },
                  "y_left": {
                    "type": "object",
                    "properties": {
                      "unit": { "type": "string", "description": "%, bp, USD, USD/share 等" },
                      "log": { "type": "boolean" },
                      "range": { "$ref": "#/$defs/num_range" }
                    }
                  },
                  "y_right": {
                    "type": "object",
                    "properties": {
                      "unit": { "type": "string", "description": "%, bp, USD, USD/share 等" },
                      "log": { "type": "boolean" },
                      "range": { "$ref": "#/$defs/num_range" }
                    }
                  }
                }
              },

              "series": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "required": ["name","unit","values"],
                  "properties": {
                    "name": { "type": "string" },
                    "unit": { "type": "string", "description": "以基准单位表示；百分比建议0–1" },
                    "values": { "type": "array", "items": { "type": ["number","null"] }, "description": "缺失用 null" },
                    "values_text": { "type": "array", "items": { "type": ["string","null"] }, "description": "原始文本（可选）" },
                    "y_axis": { "type": "string", "enum": ["left","right"], "default": "left" },
                    "role": { "type": "string", "enum": ["actual","forecast","consensus","guidance","other"], "default": "actual" },
                    "multiplier": { "type": "number", "description": "用于从原单位换算到基准单位（如亿元→元）" },
                    "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
                    "notes": { "type": "string" }
                  }
                }
              },

              "image_ref": { "type": "string", "description": "图像文件路径/ID（可选）" },
              "image_hash": { "type": "string", "description": "原图hash（便于去重）" },

              "provenance": { "$ref": "#/$defs/provenance" },

              "qa_flags": {
                "type": "array",
                "items": { "type": "string", "enum": ["missing_ticks","suspicious_sum","low_ocr_conf","unit_inferred","layout_overlap","other"] }
              },

              "raw_figure": {
                "type": "object",
                "description": "兼容/保底：吸收另一份结构的轻量表达，便于迁移与比对",
                "properties": {
                  "type": { "type": "string", "description": "如 bar_chart/pie_chart（仅做保留，不参与标准化）" },
                  "data": {
                    "type": "object",
                    "properties": {
                      "labels": { "type": "array", "items": { "type": "string" } },
                      "series": {
                        "type": "array",
                        "items": {
                          "type": "object",
                          "properties": {
                            "name": { "type": "string" },
                            "values": { "type": "array", "items": { "type": ["number","string","null"] } },
                            "unit": { "type": "string" }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        },

        "tables": {
          "type": "array",
          "description": "表格（表头+单元格结构化，适合直接落库）",
          "items": {
            "type": "object",
            "required": ["table_id","title","page","columns","rows","provenance"],
            "properties": {
              "table_id": { "type": "string" },
              "title": { "type": "string" },
              "caption": { "type": "string" },
              "page": { "type": "integer", "minimum": 1 },
              "columns": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
              "column_types": {
                "type": "object",
                "additionalProperties": { "type": "string", "enum": ["string","number","percentage","currency","date","period","other"] }
              },
              "header_units": {
                "type": "object",
                "description": "列级单位提示（如 USD mn, %）",
                "additionalProperties": { "type": "string" }
              },
              "rows": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "description": "列名→单元格的映射",
                  "additionalProperties": {
                    "oneOf": [
                      { "type": ["string","number","null"] },
                      {
                        "type": "object",
                        "properties": {
                          "value": { "type": ["number","null"] },
                          "value_text": { "type": ["string","null"] },
                          "unit": { "type": ["string","null"] },
                          "as_of": { "type": ["string","null"], "format": "date" },
                          "fiscal_period": { "type": ["string","null"], "$ref": "#/$defs/fiscal_period" },
                          "entity_id": { "type": ["string","null"] }
                        }
                      }
                    ]
                  }
                }
              },
              "provenance": { "$ref": "#/$defs/provenance" },
              "qa_flags": { "type": "array", "items": { "type": "string" } }
            }
          }
        },

        "numerical_data": {
          "type": "array",
          "description": "原子数值事实：方便纵向汇总与RAG引用",
          "items": {
            "type": "object",
            "required": ["num_id","context","metric_type","unit","value","provenance"],
            "properties": {
              "num_id": { "type": "string" },
              "entity_id": { "type": "string" },
              "context": { "type": "string", "description": "指标语境（如 iPhone revenue, ISG margin）" },
              "metric_type": {
                "type": "string",
                "enum": ["currency","percentage","basis_points","multiple","count","ratio","per_share","duration","other"]
              },
              "value": { "type": "number", "description": "基准单位可计算值（百分比建议0–1）" },
              "value_text": { "type": "string", "description": "原文字符串（如 $89.5B / 18.2%）" },
              "unit": { "type": "string", "description": "USD, %, bp, USD/share 等" },
              "scale": { "type": "string", "enum": ["ones","thousands","millions","billions","trillions"], "default": "ones" },
              "multiplier": { "type": "number", "description": "从原单位到基准单位的换算系数" },
              "rounding": { "type": "integer", "description": "原文四舍五入位数（如 1 表示1位小数）" },
              "as_of": { "type": "string", "format": "date" },
              "fiscal_period": { "$ref": "#/$defs/fiscal_period" },
              "figure_id": { "type": "string" },
              "table_id": { "type": "string" },
              "passage_id": { "type": "string" },
              "provenance": {
                "type": "object",
                "required": ["page"],
                "properties": {
                  "page": { "type": "integer", "minimum": 1 },
                  "bbox": { "$ref": "#/$defs/bbox" },
                  "sentence_id": { "type": "integer" },
                  "line_idx": { "type": "integer" },
                  "source_snippet": { "type": "string" }
                }
              },
              "confidence": { "$ref": "#/$defs/confidence" },
              "qa_flags": { "type": "array", "items": { "type": "string" } }
            }
          }
        },

        "claims": {
          "type": "array",
          "description": "文本性主张/结论，并链接证据",
          "items": {
            "type": "object",
            "required": ["claim_id","text","passage_id"],
            "properties": {
              "claim_id": { "type": "string" },
              "text": { "type": "string" },
              "label": { "type": "string", "enum": ["guidance_up","guidance_down","risk","outlook","strategy","other"] },
              "sentiment": { "type": "string", "enum": ["pos","neg","neu"] },
              "passage_id": { "type": "string" },
              "evidence": {
                "type": "object",
                "properties": {
                  "figure_ids": { "type": "array", "items": { "type": "string" } },
                  "table_ids": { "type": "array", "items": { "type": "string" } },
                  "num_ids": { "type": "array", "items": { "type": "string" } }
                }
              }
            }
          }
        },

        "relations": {
          "type": "array",
          "description": "三元组/关系：实体与指标/事件的结构化连接",
          "items": {
            "type": "object",
            "required": ["rel_id","subject","predicate","object"],
            "properties": {
              "rel_id": { "type": "string" },
              "subject": { "type": "string", "description": "entity_id 或文本" },
              "predicate": { "type": "string", "description": "如 reports, beats, guides, acquires" },
              "object": { "type": "string" },
              "time": { "type": "string", "format": "date" },
              "provenance": {
                "type": "object",
                "properties": { "page": { "type": "integer" }, "passage_id": { "type": "string" } }
              }
            }
          }
        },

        "reference_lists": {
          "type": "object",
          "description": "轻量参考清单（兼容旧结构）",
          "properties": {
            "companies": { "type": "array", "items": { "type": "string" } },
            "key_metrics": { "type": "array", "items": { "type": "string" } }
          }
        },

        "extraction_summary": {
          "type": "object",
          "required": ["figures_count","tables_count","numerical_data_count"],
          "properties": {
            "figures_count": { "type": "integer", "minimum": 0 },
            "tables_count": { "type": "integer", "minimum": 0 },
            "numerical_data_count": { "type": "integer", "minimum": 0 },
            "entities_count": { "type": "integer", "minimum": 0 },
            "passages_count": { "type": "integer", "minimum": 0 },
            "figures_with_linked_data": { "type": "integer", "minimum": 0 },
            "companies_mentioned": { "type": "integer", "minimum": 0 },
            "validation_summary": {
              "type": "object",
              "properties": {
                "original_figures": { "type": "integer", "minimum": 0 },
                "kept_figures": { "type": "integer", "minimum": 0 },
                "original_numerical": { "type": "integer", "minimum": 0 },
                "kept_numerical": { "type": "integer", "minimum": 0 },
                "method": { "type": "string" },
                "validation_method": { "type": "string", "description": "兼容旧字段名" },
                "data_accuracy_rate": { "type": "number", "minimum": 0, "maximum": 100 }
              }
            }
          }
        }
      }
    },

    "query_capabilities": {
      "type": "object",
      "properties": {
        "query_language": { "type": "string", "enum": ["jsonpath","jmespath","fieldlist"] },
        "description": { "type": "string" },
        "searchable_fields": { "type": "array", "items": { "type": "string" } },
        "figure_data_available": { "type": "boolean" },
        "can_recreate_charts": { "type": "boolean" }
      }
    },

    "errors": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "code": { "type": "string" },
          "message": { "type": "string" },
          "severity": { "type": "string", "enum": ["info","warn","error"] },
          "retryable": { "type": "boolean" }
        }
      }
    },

    "unknowns": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": { "type": "string" },
          "raw": { "type": "string" },
          "page": { "type": "integer" }
        }
      }
    },

    "compat": {
      "type": "object",
      "description": "兼容与迁移设置",
      "properties": {
        "accepts_legacy_versions": {
          "type": "array",
          "items": { "type": "string", "enum": ["1.3.0"] },
          "default": ["1.3.0"]
        },
        "type_aliases": {
          "type": "object",
          "description": "旧类型名 → 新类型名的映射，如 bar_chart→bar",
          "additionalProperties": { "type": "string" }
        },
        "qwen_legacy": { "type": "boolean" }
      }
    }
  },

  "$defs": {
    "bbox": {
      "type": "array",
      "items": { "type": "number" },
      "minItems": 4,
      "maxItems": 4,
      "description": "左上x, 左上y, 右下x, 右下y（像素/比例）"
    },
    "num_range": {
      "type": "object",
      "properties": {
        "min": { "type": ["number","null"] },
        "max": { "type": ["number","null"] }
      }
    },
    "fiscal_period": {
      "type": "string",
      "pattern": "^(FY|CY)\\d{4}((Q[1-4])|(H[12]))?$",
      "description": "支持 FY/CY + 年 + 季度/半年（如 FY2024Q4, CY2025H1）"
    },
    "confidence": {
      "type": "object",
      "properties": {
        "ocr": { "type": "number", "minimum": 0, "maximum": 1 },
        "nlp": { "type": "number", "minimum": 0, "maximum": 1 },
        "normalization": { "type": "number", "minimum": 0, "maximum": 1 },
        "overall": { "type": "number", "minimum": 0, "maximum": 1 }
      }
    },
    "provenance": {
      "type": "object",
      "required": ["page"],
      "properties": {
        "page": { "type": "integer", "minimum": 1 },
        "bbox": { "$ref": "#/$defs/bbox" },
        "source_snippet": { "type": "string" },
        "layout_block_id": { "type": "string" },
        "passage_id": { "type": "string" }
      }
    }
  }
}
